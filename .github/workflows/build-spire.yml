name: Build SPIRE macOS Binaries

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'SPIRE version to build (e.g., 1.9.6)'
        required: true
        default: '1.9.6'

permissions:
  contents: write

jobs:
  build:
    name: Build SPIRE for macOS ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: macos-15-intel
          - arch: arm64
            runner: macos-latest

    steps:
      - name: Checkout SPIRE repository
        uses: actions/checkout@v4
        with:
          repository: 'spiffe/spire'
          ref: 'v${{ github.event.inputs.version }}'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build SPIRE binaries (CGO enabled)
        env:
          CGO_ENABLED: 1
        run: |
          set -euo pipefail

          # Build spire-server
          cd cmd/spire-server
          go build -o ../../spire-server
          cd ../..

          # Build spire-agent
          cd cmd/spire-agent
          go build -o ../../spire-agent
          cd ../..

          # Create tarball
          mkdir -p spire-${{ github.event.inputs.version }}
          mv spire-server spire-agent spire-${{ github.event.inputs.version }}/

          tar -czf spire-${{ github.event.inputs.version }}-macos-${{ matrix.arch }}.tar.gz \
            spire-${{ github.event.inputs.version }}/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: spire-macos-${{ matrix.arch }}
          path: spire-${{ github.event.inputs.version }}-macos-${{ matrix.arch }}.tar.gz

  release:
    name: Create/Update GitHub Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create/Update Release metadata
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: SPIRE v${{ github.event.inputs.version }} - macOS Binaries
          draft: false
          prerelease: false
          body: |
            # SPIRE v${{ github.event.inputs.version }} - macOS Binaries

            Pre-built macOS binaries for SPIRE v${{ github.event.inputs.version }} (CGO-enabled, SQLite supported).

            ## Downloads

            - **macOS Intel (amd64)**: `spire-${{ github.event.inputs.version }}-macos-amd64.tar.gz`
            - **macOS Apple Silicon (arm64)**: `spire-${{ github.event.inputs.version }}-macos-arm64.tar.gz`

            ## Installation

            ```bash
            # Download and extract (replace {arch} with amd64 or arm64)
            wget https://github.com/${{ github.repository }}/releases/download/v${{ github.event.inputs.version }}/spire-${{ github.event.inputs.version }}-macos-{arch}.tar.gz
            tar -xzf spire-${{ github.event.inputs.version }}-macos-{arch}.tar.gz

            # Binaries are in spire-${{ github.event.inputs.version }}/ directory
            cd spire-${{ github.event.inputs.version }}/
            ./spire-server --version
            ./spire-agent --version
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload assets (overwrite existing)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="v${{ github.event.inputs.version }}"

          gh release upload "$TAG" \
            artifacts/spire-macos-amd64/spire-${{ github.event.inputs.version }}-macos-amd64.tar.gz \
            artifacts/spire-macos-arm64/spire-${{ github.event.inputs.version }}-macos-arm64.tar.gz \
            --clobber
